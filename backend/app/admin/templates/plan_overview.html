{% extends "base.html" %}

{% block title %}规划管理 - Travelist+ Admin{% endblock %}
{% block header %}规划管理 · Stage-7 Fast Planner{% endblock %}

{% block content %}
<div class="mb-6">
    <h1 class="text-2xl font-bold text-slate-800">规划管理</h1>
    <p class="text-slate-500 mt-1">Fast 规则规划可观测 · 快捷测试台（预留 Deep 模式）</p>
</div>

<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
    <div class="bg-white rounded-xl shadow-sm p-6 border border-slate-100">
        <div class="text-slate-500 text-sm font-medium mb-1">Fast 调用次数</div>
        <div class="text-3xl font-bold text-slate-800" id="metric-fast-calls">{{ summary.plan_fast_calls or 0 }}</div>
        <div class="text-xs text-slate-400 mt-2">failures: <span id="metric-fast-failures">{{ summary.plan_fast_failures or 0 }}</span></div>
    </div>
    <div class="bg-white rounded-xl shadow-sm p-6 border border-slate-100">
        <div class="text-slate-500 text-sm font-medium mb-1">Fast 平均天数</div>
        <div class="text-3xl font-bold text-slate-800" id="metric-fast-days">{{ summary.plan_fast_avg_days or 0 }}</div>
        <div class="text-xs text-slate-400 mt-2">avg days / request</div>
    </div>
    <div class="bg-white rounded-xl shadow-sm p-6 border border-slate-100">
        <div class="text-slate-500 text-sm font-medium mb-1">Fast 延迟均值</div>
        <div class="text-3xl font-bold text-slate-800" id="metric-fast-lat-mean">{{ summary.plan_fast_latency_ms_mean or 0 }}</div>
        <div class="text-xs text-slate-400 mt-2">ms / request</div>
    </div>
    <div class="bg-white rounded-xl shadow-sm p-6 border border-slate-100">
        <div class="text-slate-500 text-sm font-medium mb-1">Fast 延迟 P95</div>
        <div class="text-3xl font-bold text-slate-800" id="metric-fast-lat-p95">{{ summary.plan_fast_latency_ms_p95 or 0 }}</div>
        <div class="text-xs text-slate-400 mt-2">ms / request</div>
    </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
    <div class="lg:col-span-2 space-y-6">
        <div class="bg-white rounded-xl shadow-sm border border-slate-100">
            <div class="p-6 border-b border-slate-100 flex items-center justify-between">
                <div>
                    <h3 class="font-semibold text-slate-800">Fast 模式便捷测试台</h3>
                    <p class="text-xs text-slate-500 mt-1">直接调用 <span class="font-mono bg-slate-100 px-1.5 py-0.5 rounded">POST /api/ai/plan</span>（mode=fast）</p>
                </div>
                <div class="flex items-center gap-2">
                    <button id="btn-fast-run" onclick="runFastPlan()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-semibold transition-colors">运行 Fast</button>
                    <button onclick="fillFastSample()" class="bg-slate-100 hover:bg-slate-200 text-slate-700 px-4 py-2 rounded-lg text-sm font-semibold transition-colors">填充示例</button>
                </div>
            </div>

            <div class="p-6 grid grid-cols-12 gap-4">
                <div class="col-span-3">
                    <label class="block text-xs font-medium text-slate-600 mb-1">user_id</label>
                    <input id="fast-user-id" type="number" value="1" class="w-full border border-slate-200 rounded-md px-3 py-2 text-sm focus:border-blue-500 focus:ring-2 focus:ring-blue-500/10 outline-none">
                </div>
                <div class="col-span-5">
                    <label class="block text-xs font-medium text-slate-600 mb-1">destination</label>
                    <input id="fast-destination" type="text" value="广州" class="w-full border border-slate-200 rounded-md px-3 py-2 text-sm focus:border-blue-500 focus:ring-2 focus:ring-blue-500/10 outline-none">
                </div>
                <div class="col-span-2">
                    <label class="block text-xs font-medium text-slate-600 mb-1">start_date</label>
                    <input id="fast-start-date" type="date" class="w-full border border-slate-200 rounded-md px-3 py-2 text-sm focus:border-blue-500 focus:ring-2 focus:ring-blue-500/10 outline-none">
                </div>
                <div class="col-span-2">
                    <label class="block text-xs font-medium text-slate-600 mb-1">end_date</label>
                    <input id="fast-end-date" type="date" class="w-full border border-slate-200 rounded-md px-3 py-2 text-sm focus:border-blue-500 focus:ring-2 focus:ring-blue-500/10 outline-none">
                </div>

                <div class="col-span-6">
                    <label class="block text-xs font-medium text-slate-600 mb-1">preferences.interests（逗号分隔）</label>
                    <input id="fast-interests" type="text" value="food,sight,museum" class="w-full border border-slate-200 rounded-md px-3 py-2 text-sm focus:border-blue-500 focus:ring-2 focus:ring-blue-500/10 outline-none">
                </div>
                <div class="col-span-3">
                    <label class="block text-xs font-medium text-slate-600 mb-1">preferences.pace</label>
                    <select id="fast-pace" class="w-full border border-slate-200 rounded-md px-3 py-2 text-sm bg-white focus:border-blue-500 focus:ring-2 focus:ring-blue-500/10 outline-none">
                        <option value="">normal</option>
                        <option value="relaxed">relaxed</option>
                        <option value="fast">fast</option>
                    </select>
                </div>
                <div class="col-span-2">
                    <label class="block text-xs font-medium text-slate-600 mb-1">seed</label>
                    <input id="fast-seed" type="number" value="7" class="w-full border border-slate-200 rounded-md px-3 py-2 text-sm focus:border-blue-500 focus:ring-2 focus:ring-blue-500/10 outline-none">
                </div>
                <div class="col-span-1 flex items-end">
                    <label class="flex items-center gap-2 text-sm text-slate-700 select-none">
                        <input id="fast-save" type="checkbox" class="w-4 h-4 accent-blue-600">
                        <span>save</span>
                    </label>
                </div>

                <div class="col-span-12 grid grid-cols-2 gap-4">
                    <div>
                        <div class="flex items-center justify-between mb-2">
                            <div class="text-xs font-semibold text-slate-700">Request JSON</div>
                            <button onclick="copyFastPayload()" class="text-xs text-blue-600 hover:text-blue-800">复制</button>
                        </div>
                        <pre id="fast-request" class="text-xs bg-slate-50 border border-slate-200 rounded-lg p-3 overflow-auto h-56"></pre>
                    </div>
                    <div>
                        <div class="flex items-center justify-between mb-2">
                            <div class="text-xs font-semibold text-slate-700">Response JSON</div>
                            <div class="text-xs text-slate-500">trace: <span id="fast-trace">-</span></div>
                        </div>
                        <pre id="fast-response" class="text-xs bg-slate-50 border border-slate-200 rounded-lg p-3 overflow-auto h-56"></pre>
                    </div>
                </div>

                <div class="col-span-12">
                    <div class="text-xs font-semibold text-slate-700 mb-2">tool_traces（LangGraph 节点轨迹）</div>
                    <div id="fast-traces" class="space-y-2 text-xs text-slate-700"></div>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-sm border border-slate-100">
            <div class="p-6 border-b border-slate-100">
                <h3 class="font-semibold text-slate-800">Deep 模式测试台（预留 Stage-8）</h3>
                <p class="text-xs text-slate-500 mt-1">Stage-7 不实现 deep：用于占位字段与交互框架，便于后续无痛接入异步 task_id 流程。</p>
            </div>
            <div class="p-6 grid grid-cols-12 gap-4">
                <div class="col-span-4">
                    <label class="block text-xs font-medium text-slate-600 mb-1">request_id（建议填唯一值）</label>
                    <input id="deep-request-id" type="text" value="dev_deep_request_1" class="w-full border border-slate-200 rounded-md px-3 py-2 text-sm">
                </div>
                <div class="col-span-3">
                    <label class="block text-xs font-medium text-slate-600 mb-1">async</label>
                    <select id="deep-async" class="w-full border border-slate-200 rounded-md px-3 py-2 text-sm bg-white">
                        <option value="true" selected>true</option>
                        <option value="false">false</option>
                    </select>
                </div>
                <div class="col-span-3">
                    <label class="block text-xs font-medium text-slate-600 mb-1">seed_mode</label>
                    <select id="deep-seed-mode" class="w-full border border-slate-200 rounded-md px-3 py-2 text-sm bg-white">
                        <option value="">(empty)</option>
                        <option value="fast" selected>fast</option>
                    </select>
                </div>
                <div class="col-span-2 flex items-end">
                    <button id="btn-deep-run" onclick="runDeepPlaceholder()" class="bg-slate-800 hover:bg-slate-900 text-white px-4 py-2 rounded-lg text-sm font-semibold transition-colors w-full">运行 Deep(占位)</button>
                </div>

                <div class="col-span-12">
                    <pre id="deep-response" class="text-xs bg-slate-50 border border-slate-200 rounded-lg p-3 overflow-auto h-40"></pre>
                </div>
            </div>
        </div>
    </div>

    <div class="space-y-6">
        <div class="bg-white rounded-xl shadow-sm border border-slate-100 p-6">
            <h3 class="font-semibold text-slate-800 mb-3">测试指导（Fast）</h3>
            <div class="text-sm text-slate-700 space-y-2 leading-6">
                <p>1) 选择 <span class="font-mono bg-slate-100 px-1.5 py-0.5 rounded">user_id</span>（仅用于输出归属；save=true 时要求该用户存在）。</p>
                <p>2) 填写目的地与日期范围：确保 <span class="font-mono bg-slate-100 px-1.5 py-0.5 rounded">end_date &gt;= start_date</span>，且天数不超过 <span class="font-mono bg-slate-100 px-1.5 py-0.5 rounded">PLAN_MAX_DAYS</span>。</p>
                <p>3) 点击“运行 Fast”，观察响应：</p>
                <ul class="list-disc pl-5 text-sm text-slate-700 space-y-1">
                    <li><span class="font-mono bg-slate-100 px-1.5 py-0.5 rounded">data.plan.day_cards</span> 长度应与日期天数一致；</li>
                    <li><span class="font-mono bg-slate-100 px-1.5 py-0.5 rounded">data.metrics</span> 包含 planner/latency/candidate_pois/activities；</li>
                    <li><span class="font-mono bg-slate-100 px-1.5 py-0.5 rounded">data.tool_traces</span> 至少包含 plan_input/planner_fast/plan_validate/plan_output。</li>
                </ul>
                <p>4) 复现性测试：固定 seed 与输入，多次运行应得到一致结果；更换 seed 可观察轻微差异（兴趣轮转/POI 选择）。</p>
                <p>5) 降级测试：将 interests 设为非常冷门类型，或清空 POI 数据，仍应返回 200 且包含“自由探索”子行程，而不是 500。</p>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-sm border border-slate-100 p-6">
            <h3 class="font-semibold text-slate-800 mb-3">最近调用（Fast）</h3>
            <div id="plan-last-calls" class="space-y-2 text-xs text-slate-700"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function todayISO() {
  const d = new Date();
  const mm = String(d.getMonth() + 1).padStart(2, '0');
  const dd = String(d.getDate()).padStart(2, '0');
  return `${d.getFullYear()}-${mm}-${dd}`;
}
function addDaysISO(iso, days) {
  const d = new Date(iso);
  d.setDate(d.getDate() + days);
  const mm = String(d.getMonth() + 1).padStart(2, '0');
  const dd = String(d.getDate()).padStart(2, '0');
  return `${d.getFullYear()}-${mm}-${dd}`;
}
function pretty(obj) {
  return JSON.stringify(obj, null, 2);
}
function parseInterests(text) {
  return (text || "")
    .split(",")
    .map(s => s.trim())
    .filter(Boolean);
}

function buildFastPayload() {
  const userId = Number(document.getElementById("fast-user-id").value || 1);
  const destination = document.getElementById("fast-destination").value || "";
  const startDate = document.getElementById("fast-start-date").value;
  const endDate = document.getElementById("fast-end-date").value;
  const interests = parseInterests(document.getElementById("fast-interests").value);
  const pace = document.getElementById("fast-pace").value || undefined;
  const seed = Number(document.getElementById("fast-seed").value || 0);
  const save = document.getElementById("fast-save").checked;
  const preferences = { interests };
  if (pace) preferences.pace = pace;

  return {
    user_id: userId,
    destination,
    start_date: startDate,
    end_date: endDate,
    mode: "fast",
    save,
    seed: seed || undefined,
    preferences,
    async: false,
    request_id: null,
    seed_mode: null,
  };
}

function renderTraces(traces) {
  const root = document.getElementById("fast-traces");
  if (!traces || !traces.length) {
    root.innerHTML = `<div class="text-slate-400">暂无轨迹</div>`;
    return;
  }
  root.innerHTML = traces.map(t => {
    const status = t.status || "unknown";
    const statusCls = status === "ok" ? "text-green-600" : (status === "error" ? "text-red-600" : "text-amber-600");
    const ms = (t.latency_ms !== undefined && t.latency_ms !== null) ? `${t.latency_ms}ms` : "-";
    const detail = t.detail ? pretty(t.detail) : "";
    return `
      <div class="border border-slate-100 rounded-lg p-2 bg-white">
        <div class="flex items-center gap-2">
          <span class="px-2 py-0.5 rounded bg-slate-100 text-slate-700">${t.node}</span>
          <span class="${statusCls} font-semibold">${status}</span>
          <span class="text-slate-500">${ms}</span>
        </div>
        ${detail ? `<pre class="mt-2 text-[11px] bg-slate-50 border border-slate-200 rounded p-2 overflow-auto">${detail}</pre>` : ""}
      </div>
    `;
  }).join("");
}

function renderLastCalls(calls) {
  const root = document.getElementById("plan-last-calls");
  if (!calls || !calls.length) {
    root.innerHTML = `<div class="text-slate-400">暂无记录</div>`;
    return;
  }
  root.innerHTML = calls.map(c => {
    const okCls = c.success ? "bg-green-100 text-green-700" : "bg-red-100 text-red-700";
    return `
      <div class="flex items-center justify-between border border-slate-100 rounded-lg px-3 py-2">
        <div class="space-y-1">
          <div class="font-mono text-[11px] text-slate-600">${(c.trace_id || '').slice(0, 18)}...</div>
          <div class="text-slate-600">${c.destination} · ${c.days}天 · ${c.latency_ms}ms</div>
        </div>
        <span class="${okCls} px-2 py-0.5 rounded text-xs font-medium">${c.success ? "OK" : "FAIL"}</span>
      </div>
    `;
  }).join("");
}

async function refreshSummary() {
  try {
    const resp = await fetch("/admin/plan/summary");
    if (!resp.ok) return;
    const json = await resp.json();
    if (json.code !== 0) return;
    const d = json.data || {};
    document.getElementById("metric-fast-calls").innerText = d.plan_fast_calls ?? 0;
    document.getElementById("metric-fast-failures").innerText = d.plan_fast_failures ?? 0;
    document.getElementById("metric-fast-days").innerText = d.plan_fast_avg_days ?? 0;
    document.getElementById("metric-fast-lat-mean").innerText = d.plan_fast_latency_ms_mean ?? 0;
    document.getElementById("metric-fast-lat-p95").innerText = d.plan_fast_latency_ms_p95 ?? 0;
    renderLastCalls(d.last_10_calls || []);
  } catch (e) {
    console.warn("refreshSummary failed", e);
  }
}

async function runFastPlan() {
  const btn = document.getElementById("btn-fast-run");
  btn.disabled = true;
  try {
    const payload = buildFastPayload();
    document.getElementById("fast-request").textContent = pretty(payload);
    document.getElementById("fast-response").textContent = "Loading...";
    document.getElementById("fast-trace").textContent = "-";
    renderTraces([]);

    const resp = await fetch("/api/ai/plan", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
    });
    const json = await resp.json();
    document.getElementById("fast-response").textContent = pretty(json);
    const trace = json?.data?.trace_id || json?.data?.traceId || json?.trace_id || "-";
    document.getElementById("fast-trace").textContent = trace;
    renderTraces(json?.data?.tool_traces || []);
    await refreshSummary();
  } catch (e) {
    document.getElementById("fast-response").textContent = String(e);
  } finally {
    btn.disabled = false;
  }
}

function fillFastSample() {
  const t = todayISO();
  document.getElementById("fast-start-date").value = t;
  document.getElementById("fast-end-date").value = addDaysISO(t, 1);
  document.getElementById("fast-destination").value = "广州";
  document.getElementById("fast-interests").value = "food,sight,museum";
  document.getElementById("fast-pace").value = "";
  document.getElementById("fast-seed").value = "7";
  document.getElementById("fast-save").checked = false;
  document.getElementById("fast-request").textContent = pretty(buildFastPayload());
}

async function copyFastPayload() {
  const payload = buildFastPayload();
  try {
    await navigator.clipboard.writeText(pretty(payload));
  } catch (e) {
    console.warn("copy failed", e);
  }
}

async function runDeepPlaceholder() {
  const btn = document.getElementById("btn-deep-run");
  btn.disabled = true;
  try {
    const t = todayISO();
    const payload = {
      user_id: Number(document.getElementById("fast-user-id").value || 1),
      destination: document.getElementById("fast-destination").value || "广州",
      start_date: document.getElementById("fast-start-date").value || t,
      end_date: document.getElementById("fast-end-date").value || addDaysISO(t, 1),
      mode: "deep",
      save: false,
      preferences: { interests: parseInterests(document.getElementById("fast-interests").value) },
      people_count: 1,
      async: document.getElementById("deep-async").value === "true",
      request_id: document.getElementById("deep-request-id").value || null,
      seed_mode: document.getElementById("deep-seed-mode").value || null,
    };
    const resp = await fetch("/api/ai/plan", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
    });
    const json = await resp.json();
    document.getElementById("deep-response").textContent = pretty(json);
    await refreshSummary();
  } catch (e) {
    document.getElementById("deep-response").textContent = String(e);
  } finally {
    btn.disabled = false;
  }
}

fillFastSample();
refreshSummary();
</script>
{% endblock %}
