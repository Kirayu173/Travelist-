<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="utf-8" />
    <title>数据库结构 · Travelist+</title>
    <style>
      body {
        margin: 0;
        font-family: "Segoe UI", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
        background: #f5f7fb;
        color: #111;
      }

      header {
        padding: 20px 24px;
        background: #fff;
        border-bottom: 1px solid #e1e6f0;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      header a {
        color: #3867ff;
        text-decoration: none;
      }

      .layout {
        display: flex;
        min-height: calc(100vh - 70px);
      }

      aside {
        width: 260px;
        border-right: 1px solid #e1e6f0;
        background: #fff;
        overflow-y: auto;
      }

      .table-list {
        list-style: none;
        margin: 0;
        padding: 0;
      }

      .table-list li {
        padding: 10px 16px;
        border-bottom: 1px solid #f0f2fb;
        cursor: pointer;
      }

      .table-list li.active {
        background: #eef2ff;
        font-weight: 600;
      }

      main {
        flex: 1;
        padding: 24px;
        overflow-y: auto;
      }

      .card {
        background: #fff;
        border-radius: 10px;
        padding: 20px;
        border: 1px solid #e4e7ef;
        box-shadow: 0 6px 16px rgba(15, 27, 63, 0.04);
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 12px;
      }

      th,
      td {
        border-bottom: 1px solid #eff2f7;
        padding: 8px;
        text-align: left;
      }

      .muted {
        color: #6e7793;
        font-size: 13px;
      }

      button {
        background: #3867ff;
        border: none;
        color: #fff;
        border-radius: 6px;
        padding: 8px 14px;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <header>
      <div>
        <h2 style="margin: 0">数据库结构视图</h2>
        <div class="muted">基于 information_schema 自动生成，便于快速查阅字段、主键、索引。</div>
      </div>
      <div>
        <button type="button" onclick="refreshSchema()">刷新数据</button>
        <a href="/admin/dashboard">返回 Dashboard</a>
      </div>
    </header>

    <div class="layout">
      <aside>
        <ul id="tableNav" class="table-list"></ul>
      </aside>
      <main>
        <div class="card" id="tableDetail">
          <p class="muted">正在加载表结构...</p>
        </div>
      </main>
    </div>

    <script>
      let schemaData = {{ schema | tojson }};
      let currentTable = null;

      function renderNav() {
        const nav = document.getElementById("tableNav");
        const tables = schemaData.tables || {};
        const names = Object.keys(tables);
        if (!names.length) {
          nav.innerHTML = `<li class="muted">暂无表信息</li>`;
          document.getElementById("tableDetail").innerHTML = `<p class="muted">${schemaData.error || "请刷新以重新获取。"}</p>`;
          return;
        }
        nav.innerHTML = names
          .map(
            (name) =>
              `<li class="${currentTable === name ? "active" : ""}" onclick="selectTable('${name}')">
                ${name}
              </li>`
          )
          .join("");
        if (!currentTable) {
          selectTable(names[0]);
        }
      }

      function selectTable(name) {
        currentTable = name;
        renderNav();
        const info = schemaData.tables[name];
        const detail = document.getElementById("tableDetail");
        if (!info) {
          detail.innerHTML = `<p class="muted">未找到表 ${name}</p>`;
          return;
        }
        detail.innerHTML = `
          <h2>${name}</h2>
          <p class="muted">主键：${(info.primary_key || []).join(", ") || "无"}</p>
          ${renderColumns(info.columns)}
          ${renderForeignKeys(info.foreign_keys)}
          ${renderIndexes(info.indexes)}
        `;
      }

      function renderColumns(columns) {
        if (!columns || !columns.length) {
          return `<p class="muted">没有列信息</p>`;
        }
        return `
          <h3>字段</h3>
          <table>
            <thead>
              <tr><th>名称</th><th>类型</th><th>可空</th><th>默认值</th></tr>
            </thead>
            <tbody>
              ${columns
                .map(
                  (col) =>
                    `<tr>
                      <td>${col.name}</td>
                      <td>${col.type}</td>
                      <td>${col.nullable ? "是" : "否"}</td>
                      <td>${col.default !== undefined && col.default !== null ? col.default : "-"}</td>
                    </tr>`
                )
                .join("")}
            </tbody>
          </table>
        `;
      }

      function renderForeignKeys(fks) {
        if (!fks || !fks.length) {
          return `<p class="muted">无外键</p>`;
        }
        return `
          <h3>外键</h3>
          <table>
            <thead>
              <tr><th>字段</th><th>引用表</th><th>引用字段</th></tr>
            </thead>
            <tbody>
              ${fks
                .map(
                  (fk) =>
                    `<tr>
                      <td>${(fk.constrained_columns || []).join(", ")}</td>
                      <td>${fk.referred_table}</td>
                      <td>${(fk.referred_columns || []).join(", ")}</td>
                    </tr>`
                )
                .join("")}
            </tbody>
          </table>
        `;
      }

      function renderIndexes(indexes) {
          if (!indexes || !indexes.length) {
            return `<p class="muted">无索引</p>`;
          }
          return `
            <h3>索引</h3>
            <table>
              <thead>
                <tr><th>名称</th><th>字段</th><th>唯一</th></tr>
              </thead>
              <tbody>
                ${indexes
                  .map(
                    (idx) =>
                      `<tr>
                        <td>${idx.name}</td>
                        <td>${(idx.column_names || []).join(", ")}</td>
                        <td>${idx.unique ? "是" : "否"}</td>
                      </tr>`
                  )
                  .join("")}
              </tbody>
            </table>
          `;
      }

      async function refreshSchema() {
        const detail = document.getElementById("tableDetail");
        detail.innerHTML = `<p class="muted">刷新中...</p>`;
        try {
          const resp = await fetch("/admin/db/schema");
          const body = await resp.json();
          schemaData = (body && body.data) || {};
          currentTable = null;
          renderNav();
        } catch (err) {
          detail.innerHTML = `<p class="muted">刷新失败：${err.message}</p>`;
        }
      }

      renderNav();
    </script>
  </body>
</html>
