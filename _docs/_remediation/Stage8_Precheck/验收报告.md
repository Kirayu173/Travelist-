# Stage-8 准入整改验收报告

验收日期：2025-12-13  
验收目标：确认进入 Stage-8 前的整改项均达到预期标准，并具备可追溯证据。

## 1. 验收范围
- CI：可在 GitHub Actions 上稳定运行 lint/format/test（含 PostGIS）。
- 规划质量前置：目的地中心点 geocode 化（可配置/可回退/可缓存）。
- 可观测性：PlanMetrics 支持 Redis 持久化（可选），Admin 可展示关键指标。
- 安全：Admin SQL 调试台默认关闭，具备超时/行数限制与审计日志。
- 数据治理：逆地理增强流程可重复执行，并有验收标准。
- 冒烟：提供可重复脚本验证 plan 与指标变化。

## 2. 验收标准
1) **工程化**
- `.github/workflows/ci.yml` 启动 PostGIS 服务并设置 `DATABASE_URL`，`pytest` 可运行。
2) **功能与质量**
- `POST /api/ai/plan`（fast）仍可用，输出结构不变。
- 规划候选的 `destination_center` 来源可追踪（provider/source）。
3) **可观测性**
- `GET /admin/plan/summary` 返回 fast calls/latency p95 等指标；在 Redis backend 下重启不丢（依赖 Redis）。
4) **安全**
- `/admin/api/sql_test` 默认禁用；启用后仅允许单条 SELECT，禁止注释、多语句与危险关键字；支持 statement_timeout 与最大行数。
5) **数据治理**
- 逆地理脚本可断点续跑，输出字段满足规范。
6) **冒烟**
- 脚本能完成 plan 调用，并验证 summary 计数增加。

## 3. 验收执行记录（建议留档）
- 代码质量：`ruff check backend`、`black --check backend`
- 自动化测试：`pytest`（建议本地或容器环境，需 Postgres/PostGIS 可用）
- 冒烟：`python scripts/smoke_stage7.py`

本次验收已生成证据文件（可审计）：
- `/_docs/_remediation/Stage8_Precheck/evidence/ruff_ci_scope.txt`
- `/_docs/_remediation/Stage8_Precheck/evidence/black_ci_scope.txt`
- `/_docs/_remediation/Stage8_Precheck/evidence/pytest.txt`
- `/_docs/_remediation/Stage8_Precheck/evidence/smoke_stage7.txt`
- `/_docs/_remediation/Stage8_Precheck/evidence/uvicorn_status.txt`
- `/_docs/_remediation/Stage8_Precheck/evidence/uvicorn_stdout.txt`
- `/_docs/_remediation/Stage8_Precheck/evidence/uvicorn_stderr.txt`

## 4. 结论
- 本次整改完成后，Stage-8 准入所需的工程化护栏、质量前置与安全基线已具备。
- 建议进入 Stage-8 时优先落实：Deep async 任务存储/状态机、Redis/DB 指标聚合细化、地理中心点质量进一步评测与回退策略。
- 本次本地验收结果：`pytest -q` 为 `71 passed, 2 skipped`（见证据文件）。
