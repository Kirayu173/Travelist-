
# 智能旅游APP · 后端设计文档（FastAPI + LangGraph + PostgreSQL + Redis）

> 用途：指导本科毕设级别的后端研发与论文撰写，覆盖架构、数据库/缓存设计、API 规范、智能体编排、运维与测试。
>
> 依据：功能与阶段目标来自《APP设计说明书（正式版）》与现有《技术选型与实现方案》。

---

## 1. 目标与范围

* **目标** ：支撑“行前规划→行中发现→行程助手”的完整闭环，提供行程CRUD、POI检索、智能行程生成（规则/LLM双模）、聊天助手（流式）、地图相关数据服务。
* **范围** ：实现稳定的 REST + WebSocket 后端、以 PostgreSQL 为主库、Redis 为缓存与会话存储，并以 LangGraph 编排智能体流程。
* **不在范围** ：支付/票务直连（可扩展点保留）。

---

## 2. 架构总览

```
Android (Retrofit/WebSocket)
        ⇅
FastAPI (ASGI) — API 层 (/api/*, /ws/assistant)
        ├─ 服务层：TripService / POIService / AIService
        ├─ LangGraph：Assistant / Planner / POI / Weather / Memory 节点
        ├─ DB：PostgreSQL (SQLAlchemy + Alembic)
        ├─ Cache：Redis（缓存、会话、限流、任务状态）
        └─ 外部：高德/天气/LLM 提供商
```

* 路由与模块分层、关键节点与交互见技术选型文档。
* 交互主流程（用户输入→POI/算法/LLM→可编辑行程）与页面职责对应产品说明书“数据流程概述”。

---

## 3. 数据库设计（PostgreSQL）

> 原则： **结构化+地理空间友好+强约束+易扩展** ，支持拖拽排序、跨天调序、坐标/交通方式、收藏与会话记忆等核心功能。

### 3.1 关键表与关系（ER 概览）

* **users** (id, email, name, preferences JSONB, created_at)
* **trips** (id, user_id FK→users, destination, start_date, end_date, status, created_at)
* **day_cards** (id, trip_id FK→trips, day_index, date, note)
* **sub_trips** (id, day_card_id FK→day_cards, order_index, activity, loc_name, note, transport ENUM, geom geography(Point,4326), ext JSONB)
* **pois** (id, provider, provider_id, name, category, geom geography(Point,4326), rating, addr, ext JSONB)
* **favorites** (id, user_id FK→users, poi_id FK→pois, created_at)
* **chat_sessions** (id, user_id, trip_id NULLABLE, opened_at, closed_at, meta JSONB)
* **messages** (id, session_id FK→chat_sessions, role, content, tokens, created_at)
* **ai_tasks** (id, user_id, kind, payload JSONB, status, result JSONB, created_at, finished_at)

> 说明：`geom` 用于半径检索与路线点标；`ext` 存储外部接口回包（高德/天气）的补充字段；`messages` 支持论文复现实验审计。

### 3.2 PostgreSQL 特性

* **PostGIS** ：`geography(Point,4326)` + GiST 索引（POI/子行程坐标与附近检索）。
* **ENUM** ：`transport` ∈ {walk, bike, drive, transit}，对应产品对交通方式的约束。
* **JSONB** ：偏好、外部API结果、LLM中间态；配合 GIN 索引灵活查询。
* **约束** ：复合唯一（trip_id, day_index），（day_card_id, order_index）；外键级联删除（删除行程→级联其 day_cards/sub_trips），保证拖拽/换天后秩序一致性。

 **示例 DDL（节选）** ：

```sql
CREATE EXTENSION IF NOT EXISTS postgis;
CREATE TYPE transport AS ENUM ('walk','bike','drive','transit');

CREATE TABLE trips (
  id BIGSERIAL PRIMARY KEY,
  user_id BIGINT NOT NULL REFERENCES users(id),
  destination TEXT NOT NULL,
  start_date DATE NOT NULL,
  end_date DATE NOT NULL,
  status TEXT DEFAULT 'active',
  created_at TIMESTAMPTZ DEFAULT now()
);

CREATE TABLE day_cards (
  id BIGSERIAL PRIMARY KEY,
  trip_id BIGINT NOT NULL REFERENCES trips(id) ON DELETE CASCADE,
  day_index INT NOT NULL,
  date DATE,
  note TEXT,
  UNIQUE (trip_id, day_index)
);

CREATE TABLE sub_trips (
  id BIGSERIAL PRIMARY KEY,
  day_card_id BIGINT NOT NULL REFERENCES day_cards(id) ON DELETE CASCADE,
  order_index INT NOT NULL,
  activity TEXT NOT NULL,
  loc_name TEXT,
  note TEXT,
  transport transport,
  geom geography(Point,4326),
  ext JSONB,
  UNIQUE (day_card_id, order_index)
);

-- 索引
CREATE INDEX idx_pois_geom ON pois USING GIST (geom);
CREATE INDEX idx_sub_trips_geom ON sub_trips USING GIST (geom);
CREATE INDEX idx_messages_session ON messages(session_id, created_at);
```

### 3.3 排序与“换天/换序”一致性

* 拖拽 **换序** ：同 `day_card_id` 下调整 `order_index`，用**单事务**批量重排（避免空洞/冲突）。
* 行程 **换天** ：修改 `day_index` 并移动相关 `sub_trips` 所属 `day_card_id`；使用 `FOR UPDATE` 锁住涉及两天的行。
* 事务隔离建议：`READ COMMITTED` + 应用层幂等重试；涉及“生成结果回写”用**乐观版本号**或 `updated_at` 比较。

### 3.4 迁移与数据质量

* **Alembic** 维护迁移；`CHECK`/`NOT NULL`/`FOREIGN KEY` 保证最小正确性；对 LLM 产出的结构化 JSON 先过 **response_validator** 再落库。

---

## 4. 缓存与会话（Redis）

* **键空间约定**
  * `poi:around:{lat}:{lng}:{type}:{radius}` → 列表(JSON，TTL 10–60 min)
  * `route:{trip_id}:{day}` → 路线规划缓存（TTL 30 min）
  * `chat:session:{sid}:messages` → 最近N条（List 或 Stream，持久化落PG）
  * `ai:task:{id}` → 任务状态（生成/完成）
  * `rl:{user_id}:{api}` → 速率限制计数（滑动窗口）
* **用途** ：POI/路径**读多写少**强缓存；聊天会话 **热数据** ；AI 任务态/进度；**限流**与 **会话记忆** （MemoryNode）。

---

## 5. 领域模型（SQLAlchemy / Pydantic）

> 面向接口与论文附录，保留清晰的请求/响应模型与 ORM 实体。以下与现有 Schema 对齐。

* **Pydantic** ：`TripSchema / DayCardSchema / SubTripSchema`（后端校验 + OpenAPI）。
* **ORM** ：与上述 ER 一致，`geom` 使用 `geoalchemy2` 映射 `Geography(Point,4326)`；`transport` 映射 ENUM。
* **DTO 与视图** ：查询组合数据时以 **聚合 DTO** 返回（如行程详情含 days/sub_trips）。

---

## 6. API 设计（v1）

> 返回统一：`{ "code": 0, "msg": "ok", "data": ... }`；错误码按照 `1xxx` 业务、`2xxx` 鉴权、`3xxx` 外部依赖。核心接口与示例与选型文档一致。

### 6.1 行程与POI

* `GET /api/trips`（分页、按目的地筛选）
* `GET /api/trips/{trip_id}`（含 day_cards/sub_trips）
* `POST /api/trips`（创建+可空 days）
* `PUT /api/trips/{trip_id}`（基础信息/批量换序/换天）
* `DELETE /api/trips/{trip_id}`
* `GET /api/poi/around?lat&lng&type&radius`（PG+PostGIS 或 缓存回源高德）

### 6.2 智能体与聊天

* `POST /api/ai/plan`：`mode=fast|deep`，返回标准化 Trip JSON（深度模式可能异步，返回 `task_id` 并通过 WebSocket/轮询取结果）。
* `POST /api/ai/chat`：单轮问答（适用于无会话连接场景）。
* `WS /ws/assistant?user_id&session_id`：流式回复、事件推送（任务完成、行程生成完成等）。

### 6.3 版本化与幂等

* Header `X-API-Version: 1`；
* 幂等关键接口（创建/生成）允许 `Idempotency-Key`；服务端以 Redis 记录窗口期防重。

---

## 7. LangGraph 智能体编排

> 结合 **规则引擎（快速模式）**与**LLM（深度模式）** ，按意图路由到 Planner/POI/Weather 等节点；输出严格 JSON，经校验后落库/返回。

* **节点** ：`AssistantNode`（入口NLU）→ `PlannerNode`（行程初稿）→（若需）`PoiNode`（补全POI）/`WeatherNode`（校正户外时段）→ `ResponseValidator`（字段/坐标检查）→ `Formatter`。
* **内存** ：`MemoryNode` 读写 Redis（短期多轮上下文/用户偏好/当前 trip）。
* **回退** ：LLM 超时/非结构化 → 规则生成（距离/开放时间启发式），保证 **可用性优先** 。

---

## 8. 并发与性能

* **ASGI** ：FastAPI + Uvicorn；HTTP/WS IO 统一异步。
* **限流** ：按用户/接口 Redis 计数（或滑窗 ZSET），默认 `ai/*` 更严格。
* **任务化** ：深度生成走后台任务（可先用 `BackgroundTasks`/自建协程队列；需更强可换 Celery/RQ），结果通过 WS 推送。
* **缓存策略** ：POI/路线/LLM中间结果 TTL 5–60 分钟；命中率/失效率进入指标系统。

---

## 9. 安全与合规

* **鉴权** ：JWT（短期），所有写接口必须携带；WS 握手校验。
* **密钥** ：高德/LLM Key 仅后端持有，前端严禁直连。
* **输入校验** ：Pydantic + 白名单字段；LLM 输出二次校验。
* **审计日志** ：记录用户生成/修改行为用于复现与论文记录。

---

## 10. 运维与部署

* **进程模型** ：Gunicorn + Uvicorn Workers（CPU×2 或场景评估）；健康检查 `/healthz`。
* **配置** ：12-Factor（`DATABASE_URL`、`REDIS_URL`、`LLM_PROVIDER/*`、`GAODE_KEY`）。
* **监控** ：Prometheus 指标（QPS、P95、缓存命中、LLM 耗时、WS 会话数）；结构化日志 JSON。
* **备份** ：PG 定时备份 + Alembic 版本库；Redis RDB/AOF 视业务重要性选择。

---

## 11. 测试与验收

* **单元测试** ：服务函数、规则生成器、坐标/时间校验器。
* **集成测试** ：FastAPI 路由 + PG（Testcontainers 或事务回滚）+ Redis（fake/容器）。
* **E2E** ：移动端与后端联调，覆盖行程创建→智能生成→编辑→地图/POI。
* **性能测试** ：并发 LLM 调用/POI 缓存穿透场景。
* **验收标准** （与阶段里程碑对应）：行程 CRUD 100% 可用；普通模式 ≥90% 生成结构化 JSON；WS 流式稳定；POI 首屏 <2s。

---

## 12. 与产品/交互的一致性清单（Traceability）

* 旅行路线规划：卡片/子行程/拖拽/换天 → `trips/day_cards/sub_trips` 结构 + 排序事务。
* 智能规划：普通（规则）/深度（LLM）双模 → `POST /api/ai/plan` + `ai_tasks` + WS 通知。
* 智能助手浮窗：WS 流式聊天 → `/ws/assistant` + `chat_sessions/messages`。
* 地图与发现：定位与周边 POI → PostGIS + 高德回源 + Redis 缓存。

---

## 13. 开发实施建议（落地顺序）

1. **里程碑A** ：行程 CRUD + PG 表结构 + Alembic；
2. **里程碑B** ：POI around 接口（PG+缓存）与附近检索；
3. **里程碑C** ：规则生成（`mode=fast`）与行程落库/编辑；
4. **里程碑D** ：LangGraph 流程与 LLM（`mode=deep`）+ WS 流式；
5. **里程碑E** ：性能/安全/日志监控、论文数据导出。

---

### 附：与现有文档的对齐说明

* 产品三大模块与后端职责一一映射；整体功能边界与数据流与《正式版》一致。
* API、LangGraph 节点、异步/缓存/鉴权策略沿用并细化为 PG + Redis 的工程实践。
